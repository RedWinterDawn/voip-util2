<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <title>Jive Concurrent Calls</title>

    <link href='http://fonts.googleapis.com/css?family=Skranji:700' rel='stylesheet' type='text/css'>
    <link href='http://icalls.getjive.com:8080/static/css/style.css' rel='stylesheet' type='text/css'>

    <!--jQuery References-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js" type="text/javascript"></script>
    <!--d3.v2.min.js: git://github.com/mbostock/d3.git-->
    <script src="http://icalls.getjive.com:8080/static/libs/d3/d3.v3.1.5.min.js" type="text/javascript"></script>
    <!--cubism.v1.min.js: git://github.com/square/cubism.git-->
    <script src="http://icalls.getjive.com:8080/static/libs/cubism/cubism.v1.3.min.js" type="text/javascript"></script>

    <style>
        * {
            box-sizing: border-box;
        }
        body {
                width: 2700px;
                margin: 0 auto;
        }
        #current {
            font-size: 4.0em !important;
        }
        #timeLineHolderCallsA {
                width: 2125px;
                float: left;
                display: block;
        }
        #timelineHolderCallsA1 {
                width: 425px;
                overflow: hidden;
                float: left;
                margin: 0 auto;
        }
        #timelineHolderCallsA2 {
                width: 425px;
                overflow: hidden;
                float: left;
                margin: 0 auto;
        }
        #timeLineHolderReg {
            width: 450px;
            overflow: hidden;
            float: left;
            padding-left:25px;
        }
        #timeLineHolderReg1 {
            width: 425px;
            overflow: hidden;
            float: left;
            margin: 0 auto;
        }
        #registrations {
            text-align: center;
            width: 100%;
            color: red;
            font-size: 4.0em;
            line-height: 1em;
        }
        #timelineHolderCallsB {
                width: 1275px;
                float: left;
                display: block;
        }
        #timelineHolderCallsB1 {
                width: 425px;
                overflow: hidden;
                float: left;
                margin: 0 auto;
        }
        #timelineHolderCallsB2 {
                width: 425px;
                overflow: hidden;
                float: left;
                margin: 0 auto;
        }
        #timelineHolderCallsB3 {
                width: 425px;
                overflow: hidden;
                float: left;
                margin: 0 auto;
        }
        #colorKey {
                width: 250px;
                overflow: hidden;
                float: left;
                margin: 0 auto;
        }
        #CHI {
                color: #7bb57b;
                font-size: 2em;
                font-weight: bold;
        }
        #LAX {
                color: #7bb5ab;
                font-size: 2em;
                font-weight: bold;
        }
        #ATL {
                color: #a57bb5;
                font-size: 2em;
                font-weight: bold;
        }
        #NYC {
                color: #7b8fb5;
                font-size: 2em;
                font-weight: bold;
        }
        .horizon .value, .reg .value {
            left: 375px !important;
        }
    </style>

    <script>
        var pbx_max = {},
            listOfPbxs = [],
            listOfRegs = [],
            pbxData = {},
            regData = {},
            max = 0,
            currentTotal = 0,
            wsdatalength = 0,
            sip_reg,
            graphsGenerated = false,
            wsUrl = 'ws://icalls.getjive.com:8080/websocket',
            reconnectInterval = 5000,
            timeoutInterval = 2500;
            CHIcolors = ['#2d632d','#508c50','#7bb57b','#b0dfb0','#000000','#000000','#000000','#000000'].reverse();
            LAXcolors = ['#2d635a','#508c82','#7bb5ab','#b0dfd7','#000000','#000000','#000000','#000000'].reverse();
            NYCcolors = ['#2d4063','#506486','#7b8fb5','#b0bfdf','#000000','#000000','#000000','#000000'].reverse();
            ATLcolors = ['#542d63','#7b508c','#a57bb5','#d2b0df','#000000','#000000','#000000','#000000'].reverse();

        function startws(url) {
            if (!window.WebSocket) {
                if (window.MozWebSocket) {
                    window.WebSocket = window.MozWebSocket;
                } else {
                    $('#messages').append("<li>Your browser doesn't support WebSockets.</li>");
                }
            }
            ws = new WebSocket(url);
            var timeout = setTimeout(function() {
                timedOut = true;
                ws.close();
                timedOut = false;
            }, timeoutInterval);

            ws.onopen = function(evt) {
                clearTimeout(timeout);
                $('#messages').text('WebSocket connected.');
            }

            ws.onmessage = function(evt) {
                var ndata = JSON.parse(evt.data);
                //console.log(ndata)

                if (ndata['pbxs'] != undefined) {
                    updatePbxs(ndata['pbxs']);
                }

                if (ndata['stats'] != undefined) {
                    updateStats(ndata['stats']);
                }
            }
            ws.onerror = function(evt) {
                ws.close();
            };
            ws.onclose = function(evt) {
                clearTimeout(timeout);
                ws = null;
                $('#messages').text('WebSocket closed.');
                setTimeout(function() {
                    startws(url);
                }, reconnectInterval);
            };
        }

        function updatePbxs(json) {
            // Store the data about the PBXs in the global object
            // D3 reads from the global object as it's updated (?)
            pbxData = json;

            // Update collection of PBXs
            var updated = false;
            for (var ipAddress in pbxData) {
                if(listOfPbxs.indexOf(ipAddress) < 0) {
                    listOfPbxs.push(ipAddress);
                    updated = true;
                }
            }

            // Draw graphs if there has been a change
            if (updated) {
                graphsGenerated = true;
                prepareGraphs();
            }


        }

        function updateStats(json) {
            // Process the properties that we handle discretely.
            regData = json['sip_reg'];

            var updated = false;
            for (var ipAddress in regData) {
                var octets = ipAddress.split('.');
                var regid = octets[octets.length-1];
                if(listOfRegs.indexOf(ipAddress) < 0) {
                    listOfRegs.push(ipAddress);
                    updated = true;
                }
            }

            // Draw graphs if there has been a change
            if (updated) {
                graphsGenerated = true;
                prepareGraphs();
            }

            if (regData['total'] != undefined) {
                    max = regData['total'];
                    $('#registrations .num').text(max);
            }

            if (json['total'] != currentTotal) {
                    currentTotal = json['total'];
                    $('#current .num').text(currentTotal);
            }
        };


        $(document).ready(function() {
            startws(wsUrl);
        });
    </script>
</head>

<body>
    <div id="timeLineHolderCallsA">
        <div id="current"><span class="num">----</span> Calls</div>
        <div id="timelineHolderCallsA1"><span id='CHI'>CHI</span></div>
        <div id="timelineHolderCallsA2"><span id='CHI'>CHI</span></div>
        <div id="timelineHolderCallsB1"><span id='LAX'>LAX</span></div>
        <div id="timelineHolderCallsB2"><span id='NYC'>NYC</span></div>
        <div id="timelineHolderCallsB3"><span id='ATL'>ATL</span></div>
    </div>
    <div id="timeLineHolderReg">
        <div id="registrations"><span class="num">----</span> Reg's</div>
        <div id="timelineHolderReg1"></div>
    </div>
    <script>
        var context;

        function prepareGraphs() {

            // Defines how the graphs should update
            // step: 500 - Update the graphs every 500 milliseconds
            // size: 600 - The number of updates that constitute the displayed graph
            context = cubism.context()
                .step(2000)
                .size(375);

            // Set up the top and bottom axes
            d3.select("#timelineHolderCallsA1").selectAll(".axis")
                .data(["top", "bottom"])
            .enter().append("div")
                .attr("class", function(d) { return d + " axis"; })
                .each(function(d) { d3.select(this).call(context.axis().ticks(12).orient(d)); });

            // Generates the sliding rule
            // The line that follows the pointer when it hovers over the graphs.
            d3.select("#timelineHolderCallsA1").append("div")
                .attr("class", "rule")
                .call(context.rule());

            // Set up the top and bottom axes
            d3.select("#timelineHolderCallsA2").selectAll(".axis")
                .data(["top", "bottom"])
            .enter().append("div")
                .attr("class", function(d) { return d + " axis"; })
                .each(function(d) { d3.select(this).call(context.axis().ticks(12).orient(d)); });

            // Generates the sliding rule
            // The line that follows the pointer when it hovers over the graphs.
            d3.select("#timelineHolderCallsA2").append("div")
                .attr("class", "rule")
                .call(context.rule());

            // Set up the top and bottom axes
            d3.select("#timelineHolderCallsB1").selectAll(".axis")
                    .data(["top", "bottom"])
            .enter().append("div")
                    .attr("class", function(d) { return d + " axis"; })
                    .each(function(d) { d3.select(this).call(context.axis().ticks(12).orient(d)); });

            // Generates the sliding rule
            // The line that follows the pointer when it hovers over the graphs.
            d3.select("#timelineHolderCallsB1").append("div")
                .attr("class", "rule")
                .call(context.rule());

            // Set up the top and bottom axes
            d3.select("#timelineHolderCallsB2").selectAll(".axis")
                    .data(["top", "bottom"])
            .enter().append("div")
                    .attr("class", function(d) { return d + " axis"; })
                    .each(function(d) { d3.select(this).call(context.axis().ticks(12).orient(d)); });

            // Generates the sliding rule
            // The line that follows the pointer when it hovers over the graphs.
            d3.select("#timelineHolderCallsB2").append("div")
                .attr("class", "rule")
                .call(context.rule());

            // Set up the top and bottom axes
            d3.select("#timelineHolderCallsB3").selectAll(".axis")
                    .data(["top", "bottom"])
            .enter().append("div")
                    .attr("class", function(d) { return d + " axis"; })
                    .each(function(d) { d3.select(this).call(context.axis().ticks(12).orient(d)); });

            // Generates the sliding rule
            // The line that follows the pointer when it hovers over the graphs.
            d3.select("#timelineHolderCallsB3").append("div")
                .attr("class", "rule")
                .call(context.rule());

            // Set up the top and bottom axes
            d3.select("#timelineHolderReg1").selectAll(".axis")
                .data(["top", "bottom"])
            .enter().append("div")
                .attr("class", function(d) { return d + " axis"; })
                .each(function(d) { d3.select(this).call(context.axis().ticks(12).orient(d)); });

            // Generates the sliding rule
            // The line that follows the pointer when it hovers over the graphs.
            d3.select("#timelineHolderReg1").append("div")
                .attr("class", "rule")
                .call(context.rule());

            // Controls what happens during mouseover's.
            // Currently, updates the placement of the PBX counts.
            context.on("focus", function(i) {
                d3.selectAll(".value").style("left", i == null ? null : i + "px");
            });

            generateGraphs();
            generateRegGraph();
        }

        function ipToInt(dot) {
            var parts = dot.split(".");
            var res = 0;

            if (isNaN(parseInt(parts[0])))
                return null;

            res += (parseInt(parts[0], 10) << 24) >>> 0;
            res += (parseInt(parts[1], 10) << 16) >>> 0;
            res += (parseInt(parts[2], 10) << 8) >>> 0;
            res += parseInt(parts[3], 10) >>> 0;

            return res;
        }

        /**
         * Create a new graph for each PBX as it is identified.
         * The graph is created with the pre-defined context, so it will follow
         * the update pattern defined for that context.
         */
        function generateGraphs() {
            listOfPbxs.sort(function (a,b) {
                var aIP = ipToInt(a);
                var bIP = ipToInt(b);
                return aIP - bIP;
            });

                /*
            listOfPbxs.sort(function(a,b) {
                var aOctets = a.split('.');
                var bOctets = b.split('.');
                var first = parseInt(aOctets[aOctets.length-1]);
                var second = parseInt(bOctets[bOctets.length-1]);

                return first - second;
                var aa = a[0].split(".");
                var bb = b[0].split(".");

                var resulta = aa[0]*0x1000000 + aa[1]*0x10000 + aa[2]*0x100 + aa[3]*1;
                var resultb = bb[0]*0x1000000 + bb[1]*0x10000 + bb[2]*0x100 + bb[3]*1;

                return resulta-resultb;

            });
                */
            var timeSeriesMap = listOfPbxs.map(generateTimeSeries);

            var series1, series2, series3;
            var tripsies = Math.floor(timeSeriesMap.length/3);

            series1 = timeSeriesMap.splice(0, 26); // CHI1
            series2 = timeSeriesMap.splice(0, 26); // CHI2
            series3 = timeSeriesMap.splice(0, 34); // LAX
            series4 = timeSeriesMap.splice(0, 34); // NYC
            series5 = timeSeriesMap; // ATL

            console.log(series1, series2, series3, series4, series5)

            d3.select("#timelineHolderCallsA1").selectAll(".horizon")
                .remove();
            d3.select("#timelineHolderCallsA1").selectAll(".horizon")
                .data(series1)
                .enter().insert("div", ".bottom")
                .attr("class", "horizon")
                .call(context.horizon().extent([0, 250]).colors(CHIcolors));
            d3.select("#timelineHolderCallsA1").selectAll(".horizon")
                .append("span")
                .attr("id",function(d){
                    return d;
                })
                .attr("class","pbxMax");

            d3.select("#timelineHolderCallsA2").selectAll(".horizon")
                .remove();
            d3.select("#timelineHolderCallsA2").selectAll(".horizon")
                .data(series2)
                .enter().insert("div", ".bottom")
                .attr("class", "horizon")
                .call(context.horizon().extent([0, 250]).colors(CHIcolors));
            d3.select("#timelineHolderCallsA2").selectAll(".horizon")
                .append("span")
                .attr("id",function(d){
                    return d;
                })
                .attr("class","pbxMax");

            d3.select("#timelineHolderCallsB1").selectAll(".horizon")
                    .remove();
            d3.select("#timelineHolderCallsB1").selectAll(".horizon")
                    .data(series3)
                    .enter().insert("div", ".bottom")
                    .attr("class", "horizon")
                    .call(context.horizon().extent([0, 250]).colors(LAXcolors));
            d3.select("#timelineHolderCallsB1").selectAll(".horizon")
                    .append("span")
                    .attr("id",function(d){
                            return d;
                    })
                    .attr("class","pbxMax");

            d3.select("#timelineHolderCallsB2").selectAll(".horizon")
                    .remove();
            d3.select("#timelineHolderCallsB2").selectAll(".horizon")
                    .data(series4)
                    .enter().insert("div", ".bottom")
                    .attr("class", "horizon")
                    .call(context.horizon().extent([0, 250]).colors(NYCcolors));
            d3.select("#timelineHolderCallsB2").selectAll(".horizon")
                    .append("span")
                    .attr("id",function(d){
                            return d;
                    })
                    .attr("class","pbxMax");

            d3.select("#timelineHolderCallsB3").selectAll(".horizon")
                    .remove();
            d3.select("#timelineHolderCallsB3").selectAll(".horizon")
                    .data(series5)
                    .enter().insert("div", ".bottom")
                    .attr("class", "horizon")
                    .call(context.horizon().extent([0, 250]).colors(ATLcolors));
            d3.select("#timelineHolderCallsB3").selectAll(".horizon")
                    .append("span")
                    .attr("id",function(d){
                            return d;
                    })
                    .attr("class","pbxMax");

            for(var key in pbx_max){
                $("#"+key).text(pbx_max[key]);
            }
        }

        function generateRegGraph() {
            listOfRegs.sort(function(a,b) {
                var aIP = ipToInt(a);
                var bIP = ipToInt(b);
                return aIP - bIP;
            });
            /*
            listOfRegs.sort(function(a,b) {
                var aOctets = a.split('.');
                var bOctets = b.split('.');
                var first = parseInt(aOctets[aOctets.length-1]);
                var second = parseInt(bOctets[bOctets.length-1]);

                return first - second;
            });
            */
            var timeSeriesMap = listOfRegs.map(generateRegMap);
            d3.select("#timelineHolderReg1").selectAll(".reg")
                .remove();
            d3.select("#timelineHolderReg1").selectAll(".reg")
                .data(timeSeriesMap)
                .enter().insert("div", ".bottom")
                .attr("class", "reg")
                .call(context.horizon().extent([0, 70000]));
        }


        function generateRegMap(regId) {
            var value = 0,
                values = [],
                i = 0,
                last = 0;
            return context.metric(function(start, stop, step, callback) {
                start = +start;
                stop = +stop;
                if (last == 0) {
                    last = start;
                    while (last < stop) {
                        last += step;
                        values.push(0);
                    }
                } else {
                    value = regData[regId]  ;
                    values.push(value);
                }
                callback(null, values = values.slice((start - stop) / step));
            }, regId)
        }

        // Replace this with context.graphite and graphite.metric!
        function generateTimeSeries(pbxId) {
            //console.log(pbxId);
            var value = 0,
                values = [],
                i = 0,
                last = 0;
            return context.metric(function(start, stop, step, callback) {
                start = +start;
                stop = +stop;
                if (last == 0) {
                    last = start;
                    while (last < stop) {
                        last += step;
                        values.push(0);
                    }
                } else {
                    value = pbxData[pbxId]['calls'];
                    values.push(value);
                }
                values = values.slice((start - stop) / step);
                callback(null, values);
            }, pbxId);
        }
    </script>
    <div id="messages"></div>
